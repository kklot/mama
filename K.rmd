---
title: "Mama study"
author: "Kính"
output:
    html_document:
        toc: true
        toc_float: true
        code_folding: hide
always_allow_html: true
---

```{r setup, include=F}
source("/Users/knguyen/Documents/libs.r")
select <- dplyr::select
```

```{r readdata}
d <- readxl::read_excel(here("./2_23_Amandla mama data_.xlsx"), col_types = "text")
d %<>%
    rename(
        id = `Participant number`,
        rid = `Randomisation code`,
        agec = Age,
        area = `Facility`,
        video = `Did you receive the videos?`,
        video_any = `Did you see the videos from anyone?2`,
        momconnect = `Are you enrolled on MomConnect?`,
        age = `How   old are you?`,
        edu = `What is the highest standard or grade you have completed at school?`,
        race = `With which race group do you identify?`,
        nat = `What nationality are you?`,
        work = `Have you worked to earn money in the last 12 months?`,
        earn = `How much do you earn per month, before tax, including benefits?`,
        partner = `Do you have a partner?`,
        reli = `What is your religion, if you have one?`,
        k9_F = `Kangaroo mother care should be avoided because it makes breastfeeding difficult`,
        k10_T = `Drinking breastmilk prevents infections in a baby`,
        k11_T = `Breastmilk alone provides enough nutrition until babies are 6 months old`,
        k12_F = `Babies should be given water or cooled tea in addition to breastmilk when it is hot outside`,
        k13_F = `Formula feeding is healthier for babies than breastfeeding if mothers can afford it`,
        k14_F = `Babies under six months should be given muti if recommended by a sangoma`,
        k15_F = `Pregnant mothers should avoid fruits because it will be too acidic for the baby`,
        k16_F = `It’s okay to drink alcohol when pregnant because it relaxes the mother`,
        k17_T = `Iron is found in green vegetables as well as meat`,
        k18_T = `It is important for pregnant women to get enough nutrients in their meals`,
        k19_T = `Beans are an excellent source of protein`,
        k20_F = `Eggs are an excellent source of starch`,
        k21_F = `Women don’t need to care for themselves during pregnancy`,
        k22_T = `Pregnant women should visit the clinic regularly to check for infections that can affect the baby`,
        k23_F = `A pregnant woman should not eat healthy food if the baby is growing well`,
        k24_T = `Immunization help to protect newborn babies from getting sick`,
        k25_F = `Immunization are dangerous for newborn babies and should be delayed until the child is older`,
        k26_F = `Difficulty sleeping during late pregnancy is a danger sign`,
        k27_T = `Severe headaches during late pregnancy are danger signs`,
        k28_T = `Feeling your baby kick is normal during late pregnancy`,
        k29_F = `Bleeding from the vagina is normal during late pregnancy`,
        k30_F = `When a newborn baby loses some weight in the first week it is a danger sign`,
        k31_T = `When a newborn has a fever in the first week it is a danger sign`,
        k32_F = `When a newborn cries a lot at night, it is a danger sign.`,
        k33_F = `When a newborn has black stools in the first week, it is a danger sign`,
        k34_T = `Pregnant women should visit the clinic regularly, even if they feel fine`,
        k35_T = `Pregnant women should exercise`,
        k36_F = `Newborn babies can be given porridge to help them gain weight and sleep better.`
    ) %>%
    select(1:43)
```

Some issues:

- 8 have repeated IDs with different records --> assume they are different
- 2 with missing all the answer to knowledge --> removed
- no id 73, but two 28, it seems the second one is 73 based on video category


```{r meta_group}
read.csv("cate.csv") %>%
    mutate(
        q = paste0("k", q),
        across(pc:bfnc, as_numeric)
    ) %>%
    allot(cate)

# PP or ITT
pp_id <- c(8, 28, 80, 300, 342, 382, 49, 36, 252, 75, 73, 111)
```

```{r recoding_answer}
d %>%
    filter(!id %in% c(98, 103)) %>% # no answers
    mutate(
        id_ = 1:n(), 
        id = if_else(id_ == 15, '73', id),
        pp = video,
        itt = if_else(id %in% pp_id, 'Yes', video)
    ) %>%
    pivot_longer(starts_with("k"), names_sep = "_", names_to = c("q", "ref")) %>%
    mutate(
        value = stringr::str_trim(tolower(value)),
        score = case_when(
            value == "don't know" ~ 0,
            value == "true" & ref == "T" ~ 1,
            value == "false" & ref == "F" ~ 1,
            value == "true" & ref == "F" ~ 0,
            value == "false" & ref == "T" ~ 0,
            otherwise ~ NA_real_
        )
    ) %>%
    select(-ref, -value) %>%
    pivot_wider(, names_from = q, values_from = score) %>%
    allot(d_)
```

## Data {.tabset}

### Demographics and ITT

> Who was assigned to treatment group will be in treatment group, regardless of
> the actual received treatment.

We can make one big table combining these to show that the two groups are
comparable as there are no signigicant differences in demographics. 

```{r demo_itt, results='asis'}
# d_ %<>% mutate(age = factor(age, levels = c('18-24', '25-34', ">35")))
# d_ %<>% mutate(age = as.numeric(age))
d_ %<>% mutate(edu = if_else(edu == "No formal education", "Primary school", edu))
d_ %<>% mutate(age = factor(age, c("18-24", "25-34", ">35")))
d_ %<>% mutate(nat = if_else(nat != "South African", 'Others', nat))
d_ %<>% mutate(across(c(edu, work, partner, momconnect,area), as.factor))

# d_ %>% tabstat(edu, momconnect)

rbind(
    d_ %>% tabstat(age, itt),
    d_ %>% tabstat(edu, itt),
    d_ %>% tabstat(area, itt),
    d_ %>% tabstat(race, itt),
    d_ %>% tabstat(nat, itt),
    d_ %>% tabstat(work, itt),
    d_ %>% tabstat(earn, itt),
    d_ %>% tabstat(partner, itt),
    d_ %>% tabstat(momconnect, itt)
) %>%
kable() %>%
    kable_classic(full_width = F, html_font = "Cambria") %>%
    add_header_above(c(" " = 1, "Video" = 2, " " = 1, " " = 1)) %>%
    pack_rows("Age", 1, 3) %>%
    pack_rows("Education", 4, 5) %>%
    pack_rows("Area", 6, 7) %>%
    pack_rows("Race", 8, 9) %>%
    pack_rows("Nationality", 10, 11) %>%
    pack_rows("Work", 12, 13) %>%
    pack_rows("Earning", 14, 16) %>%
    pack_rows("Partner", 17, 18) %>%
    pack_rows("MomConnect", 19, 20)
```

### Demographics and per-protocol

This shows that the two groups are comparable as there are no signigicant
differences in demographics. 

```{r demo_pp, results='asis'}
rbind(
    d_ %>% tabstat(age, pp),
    d_ %>% tabstat(edu, pp),
    d_ %>% tabstat(area, pp),
    d_ %>% tabstat(race, pp),
    d_ %>% tabstat(nat, pp),
    d_ %>% tabstat(work, pp),
    d_ %>% tabstat(earn, pp),
    d_ %>% tabstat(partner, pp),
    d_ %>% tabstat(momconnect, pp)
) %>%
kable() %>%
    kable_classic(full_width = F, html_font = "Cambria") %>%
    add_header_above(c(" " = 1, "Video" = 2, " " = 1, " " = 1)) %>%
    pack_rows("Age", 1, 3) %>%
    pack_rows("Education", 4, 5) %>%
    pack_rows("Area", 6, 7) %>%
    pack_rows("Race", 8, 9) %>%
    pack_rows("Nationality", 10, 11) %>%
    pack_rows("Work", 12, 13) %>%
    pack_rows("Earning", 14, 16) %>%
    pack_rows("Partner", 17, 18) %>%
    pack_rows("MomConnect", 19, 20)
```

### Scores distribution

There are 11 individuals with at least one missing questions, sensitivity will
be done using imputation to have the full data for analyses. The imputed data
including age, edu, work, partner, and all 28 knowledge questions.

```{r score_distribution, include=F}
d_ %>%
    mutate(score = rowSums(across(starts_with("k")))) %>%
    count(score) %>%
    kable()
```

Considering the total score distribution

- Small increase in group with video intervention, both PP and ITT
classification, clearer increase in the ITT. 
- Age-group >35 have high score than others age-groups

```{r score_distribution_plot}
set.seed(2908)
dm <- mice::mice(d_, 10, print = F)
```

```{r plot_dist, fig.dim = c(7, 7)}
d5 <- complete(dm, 5) %>%
    mutate(score = rowSums(across(starts_with("k"))))

fpp <- d5 %>%
    ggplot(aes(factor(pp), score))  + geom_boxplot() +
    labs(x = "PP") + coord_flip()
fitt <- d5 %>%
    ggplot(aes(factor(itt), score))  + geom_boxplot() +
    labs(x = "ITT") + coord_flip()
fage <- d5 %>%
    ggplot(aes(factor(age), score))  + geom_boxplot() +
    labs(x = "ITT") + coord_flip()
fedu <- d5 %>%
    ggplot(aes(factor(edu), score))  + geom_boxplot() +
    labs(x = "edu") + coord_flip()
fwork <- d5 %>%
    ggplot(aes(factor(work), score))  + geom_boxplot() +
    labs(x = "work") + coord_flip()
fpartner <- d5 %>%
    ggplot(aes(factor(partner), score))  + geom_boxplot() +
    labs(x = "partner") + coord_flip()
fmom <- d5 %>%
    ggplot(aes(factor(momconnect), score))  + geom_boxplot() +
    labs(x = "Momconnect") + coord_flip()
farea <- d5 %>%
    ggplot(aes(factor(area), score))  + geom_boxplot() +
    labs(x = "Area") + coord_flip()
(fpp + fitt + fage + fedu) / (fwork + fpartner + fmom + farea)
```

## Ordinal outcome

Assuming the interval are equidistane in each question, the sum of numeric score
is also an interval variable for which we can model with a *ordinal regression*
model.

> If the 95% not touching zero line it is equivalent to signigicant effect. 

To be written out later:

- `ppYes`: Watched video - per protocol assignment of 12 individuals
- `ittYes`: Watched video - intention to treat assignment of 12 individuals

There are not much differences between PP and ITT.

### Per protocol

```{r fit_order}
library("rstanarm")
post0 <- stan_polr(
    score ~ pp + age + edu + work + partner + momconnect + area,
    data =
        complete(dm, 1) %>%
            mutate(
                score = rowSums(across(starts_with("k"))),
                score = factor(score)
            ),
    prior = R2(0.25), prior_counts = dirichlet(1), seed = 12345, refresh = 0
)

# loom <- loo(post0)
# loo::pareto_k_ids(loom)

plot(post0, regex_pars = "^pp|age|edu|work|partner|mom|area") +
    labs(
        title = "Effect on the odds of having a higher total knowledge score",
        caption = "Bold and thin line are 50% and 95% CI, respectively."
    ) +
    theme(
        axis.text.y = element_text(size = 12)
    )
```

### ITT

```{r fit_order_ITT}
post0 <- stan_polr(
    score ~ itt + age + edu + work + partner + momconnect + area,
    data =
        complete(dm, 1) %>%
            mutate(
                score = rowSums(across(starts_with("k"))),
                score = factor(score)
            ),
    prior = R2(1), 
    prior_counts = dirichlet(), 
    seed = 12345, refresh = 0
)

plot(post0, regex_pars = "^itt|age|edu|work|partner|mom|area") +
    labs(
        title = "Effect on the odds of having a higher total knowledge score",
        caption = "Bold and thin line are 50% and 95% CI, respectively."
    ) +
    theme(
        axis.text.y = element_text(size = 12)
    )
```

### Subgroup analyses - intention to treat

```{r score_group}
select <- dplyr::select

complete(dm, 1) %>%
    pivot_longer(starts_with("k"), names_to = "q") %>%
    select(id_, q, value) %>%
    left_join(cate, "q") %>%
    mutate(across(4:7, function(x) value * (x - 1))) %>%
    group_by(id_) %>%
    summarise(
        pc = sum(pc),
        bf = sum(bf),
        nc = sum(nc),
        bfnc = sum(bfnc)
    ) %>%
    mutate(across(2:5, as.factor)) %>%
    allot(score_grp)
```

```{r itt_subgroup, fig.dim = c(7, 6)}
complete(dm, 1) %>%
    left_join(score_grp, 'id_') %>%
    allot(dm1)

postpc <- stan_polr(
    pc ~ itt + age + edu + work + partner + momconnect + area,
    data = dm1, prior = R2(1), prior_counts = dirichlet(), seed = 12345, refresh = 0
)
postbf <- stan_polr(
    bf ~ itt + age + edu + work + partner + momconnect + area,
    data = dm1, prior = R2(1), prior_counts = dirichlet(), seed = 12345, refresh = 0
)
postnc <- stan_polr(
    nc ~ itt + age + edu + work + partner + momconnect + area,
    data = dm1, prior = R2(1), prior_counts = dirichlet(), seed = 12345, refresh = 0
)
postbfnc <- stan_polr(
    bfnc ~ itt + age + edu + work + partner + momconnect + area,
    data = dm1, prior = R2(1), prior_counts = dirichlet(), seed = 12345, refresh = 0
)

bind_rows(
    pc = postpc$stan_summary %>% as_tibble(rownames = NA) %>% rownames_to_column(),
    bf = postbf$stan_summary %>% as_tibble(rownames = NA) %>% rownames_to_column(),
    nc = postnc$stan_summary %>% as_tibble(rownames = NA) %>% rownames_to_column(),
    bfnc = postbfnc$stan_summary %>% as_tibble(rownames = NA) %>% rownames_to_column(),
    .id = "x"
) %>%
filter(str_detect(rowname, "^itt|age|edu|work|partner|mom|area")) %>%
    ggplot(aes(rowname, `50%`, color = x)) +
    geom_hline(yintercept = 0, linewidth = .7, linetype = "dashed") +
    geom_linerange(aes(ymin = `2.5%`, ymax = `97.5%`), linewidth = 1) +
    geom_linerange(aes(ymin = `25%`, ymax = `75%`), linewidth = 2) +
    geom_point(size = 3, shape = 21, fill = '#f6f6f6') +
    facet_wrap(~x, labeller = as_labeller(
        c(
            `bf` = "Breastfeeding",
            `nc` = "Newborn care", `pc` = "Pregnancy care",
            `bfnc` = "Breastfeeding & Newborn care"
        )
    )) +
    coord_flip() +
    labs(
        title = "Ordinal regression by sub-groups (ITT)",
        x = "Covariates", 
        y = "Regression coefficient, line is 50% (bold) and 95% (thin) CI") +
    scale_color_manual(values = thematic::okabe_ito(7)) +
    guides(color = "none") +
    theme_light() +
    theme(
        strip.background = element_rect(fill = "grey50"),
        panel.grid.major.x = element_blank(), text = element_text(size = 12)
    )
```

### Subgroup analyses - per protocol

```{r score_group_pp}
complete(dm, 10) %>%
    pivot_longer(starts_with("k"), names_to = "q") %>%
    select(id_, q, value) %>%
    left_join(cate, "q") %>%
    mutate(across(4:7, function(x) value * (x - 1))) %>%
    group_by(id_) %>%
    summarise(
        pc = sum(pc),
        bf = sum(bf),
        nc = sum(nc),
        bfnc = sum(bfnc)
    ) %>%
    mutate(across(2:5, as.factor)) %>%
    allot(score_grp)
```

```{r pp_subgroup, fig.dim = c(7, 6)}
complete(dm, 10) %>%
    left_join(score_grp, 'id_') %>%
    allot(dm1)

postpc <- stan_polr(
    pc ~ itt + age + edu + work + partner + momconnect + area,
    data = dm1, prior = R2(1), prior_counts = dirichlet(), seed = 12345, refresh = 0
)
postbf <- stan_polr(
    bf ~ itt + age + edu + work + partner + momconnect + area,
    data = dm1, prior = R2(1), prior_counts = dirichlet(), seed = 12345, refresh = 0
)
postnc <- stan_polr(
    nc ~ itt + age + edu + work + partner + momconnect + area,
    data = dm1, prior = R2(1), prior_counts = dirichlet(), seed = 12345, refresh = 0
)
postbfnc <- stan_polr(
    bfnc ~ itt + age + edu + work + partner + momconnect + area,
    data = dm1, prior = R2(1), prior_counts = dirichlet(), seed = 12345, refresh = 0
)

bind_rows(
    pc = postpc$stan_summary %>% as_tibble(rownames = NA) %>% rownames_to_column(),
    bf = postbf$stan_summary %>% as_tibble(rownames = NA) %>% rownames_to_column(),
    nc = postnc$stan_summary %>% as_tibble(rownames = NA) %>% rownames_to_column(),
    bfnc = postbfnc$stan_summary %>% as_tibble(rownames = NA) %>% rownames_to_column(),
    .id = "x"
) %>%
filter(str_detect(rowname, "^itt|age|edu|work|partner|mom")) %>%
    ggplot(aes(rowname, `50%`, color = x)) +
    geom_hline(yintercept = 0, linewidth = .7, linetype = "dashed") +
    geom_linerange(aes(ymin = `2.5%`, ymax = `97.5%`), linewidth = 1) +
    geom_linerange(aes(ymin = `25%`, ymax = `75%`), linewidth = 2) +
    geom_point(size = 3, shape = 21, fill = '#f6f6f6') +
    facet_wrap(~x, labeller = as_labeller(
        c(
            `bf` = "Breastfeeding",
            `nc` = "Newborn care", `pc` = "Pregnancy care",
            `bfnc` = "Breastfeeding & Newborn care"
        )
    )) +
    coord_flip() +
    labs(
        title = "Ordinal regression by sub-groups (PP)",
        x = "Covariates", 
        y = "Regression coefficient, line is 50% (bold) and 95% (thin) CI") +
    scale_color_manual(values = thematic::okabe_ito(7)) +
    guides(color = "none") +
    theme_light() +
    theme(
        strip.background = element_rect(fill = "grey50"),
        panel.grid.major.x = element_blank(), text = element_text(size = 12)
    )
```

